{% load static %}
<!DOCTYPE html>
<html>
  <head>
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600,700,300' rel='stylesheet' type='text/css'>
    
    <link rel='stylesheet prefetch' href='https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css'>
    <link rel='stylesheet prefetch' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.2/css/font-awesome.min.css'>
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
    <script src="//code.jquery.com/jquery-1.11.1.min.js"></script>
    <style>
      body {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  background: #2C3E50;
  font-family: "proxima-nova", "Source Sans Pro", sans-serif;
  font-size: 1em;
  letter-spacing: 0.1px;
  color: #32465a;
  text-rendering: optimizeLegibility;
  text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.004);
  -webkit-font-smoothing: antialiased;
}

.time {
  z-index: 9998;
}

a:focus {
    outline: none;
}

.messages {
  height: 100px;
  overflow: auto;
  display: flex;
  flex-direction: column-reverse;
}

/* #scrollToBottomIcon {
    position: fixed;
    bottom: 50px;
    right: 20px;
    color: #fff;
    font-size: 20px;
    border-radius: 50%;
    cursor: pointer;
} */

.floating, #floating-btn {  
    animation-name: floating;
    animation-duration: 2s;
    animation-iteration-count: infinite;
    animation-timing-function: ease-in-out;
    margin-left: 30px;
    margin-top: 5px;
    position: absolute;
    top: 10%;
    left: 50%;
    right: 50%;
    transform: translate(-50%, -50%);
    
    /* Set a high z-index value to ensure it's not covered */
    z-index: 9999;
}

 
@keyframes floating {
    0% { transform: translate(0,  0px); }
    50%  { transform: translate(0, 15px); }
    100%   { transform: translate(0, -0px); }    
}


.new-msg-btn {
  background-color: white;
  color: #27ae60;
  border: none;
  /* border-radius: 5%; */
  /* width: 200px; */
  
}

.new-msg-btn:hover {
  background-color: #27ae60;
  color: white;
}


#frame {
  width: 100%;
  min-width: 360px;
  height: 100vh;
  min-height: 300px;
  background: #E6EAEA;
}
@media screen and (max-width: 360px) {
  #frame {
    width: 100%;
    height: 100vh;
  }
}
#frame #sidepanel {
  float: left;
  min-width: 280px;
  max-width: 340px;
  width: 40%;
  height: 100%;
  background: #2c3e50;
  color: #f5f5f5;
  overflow: hidden;
  position: relative;
}
@media screen and (max-width: 735px) {
  #frame #sidepanel {
    width: 100px;
    min-width: 100px;
  }
}
#frame #sidepanel #profile {
  width: 80%;
  margin: 25px auto;
}
@media screen and (max-width: 735px) {
  #frame #sidepanel #profile {
    width: 100%;
    margin: 0 auto;
    padding: 5px 0 0 0;
    background: #32465a;
  }
}
#frame #sidepanel #profile.expanded .wrap {
  height: 210px;
  line-height: initial;
}
#frame #sidepanel #profile.expanded .wrap p {
  margin-top: 20px;
}
#frame #sidepanel #profile.expanded .wrap i.expand-button {
  -moz-transform: scaleY(-1);
  -o-transform: scaleY(-1);
  -webkit-transform: scaleY(-1);
  transform: scaleY(-1);
  filter: FlipH;
  -ms-filter: "FlipH";
}
#frame #sidepanel #profile .wrap {
  height: 65px;
  line-height: 65px;
  overflow: hidden;
  -moz-transition: 0.3s height ease;
  -o-transition: 0.3s height ease;
  -webkit-transition: 0.3s height ease;
  transition: 0.3s height ease;
}
@media screen and (max-width: 735px) {
  #frame #sidepanel #profile .wrap {
    height: 65px;
  }
}
#frame #sidepanel #profile .wrap img {
  width: 60px;
  border-radius: 50%;
  padding: 3px;
  border: 2px solid #e74c3c;
  height: auto;
  float: left;
  cursor: pointer;
  -moz-transition: 0.3s border ease;
  -o-transition: 0.3s border ease;
  -webkit-transition: 0.3s border ease;
  transition: 0.3s border ease;
}
@media screen and (max-width: 735px) {
  #frame #sidepanel #profile .wrap img {
    width: 60px;
    margin-left: 4px;
  }
}
#frame #sidepanel #profile .wrap img.online {
  border: 2px solid #2ecc71;
}
#frame #sidepanel #profile .wrap img.away {
  border: 2px solid #f1c40f;
}
#frame #sidepanel #profile .wrap img.busy {
  border: 2px solid #e74c3c;
}
#frame #sidepanel #profile .wrap img.offline {
  border: 2px solid #95a5a6;
}
#frame #sidepanel #profile .wrap p {
  float: left;
  margin-left: 15px;
}
@media screen and (max-width: 735px) {
  #frame #sidepanel #profile .wrap p {
    display: none;
  }
}
#frame #sidepanel #profile .wrap i.expand-button {
  float: right;
  margin-top: 23px;
  font-size: 0.8em;
  cursor: pointer;
  color: #435f7a;
}
@media screen and (max-width: 735px) {
  #frame #sidepanel #profile .wrap i.expand-button {
    display: none;
  }
}
#frame #sidepanel #profile .wrap #status-options {
  position: absolute;
  opacity: 0;
  visibility: hidden;
  width: 150px;
  margin: 70px 0 0 0;
  border-radius: 6px;
  z-index: 99;
  line-height: initial;
  background: #435f7a;
  -moz-transition: 0.3s all ease;
  -o-transition: 0.3s all ease;
  -webkit-transition: 0.3s all ease;
  transition: 0.3s all ease;
}
@media screen and (max-width: 735px) {
  #frame #sidepanel #profile .wrap #status-options {
    width: 58px;
    margin-top: 57px;
  }
}
#frame #sidepanel #profile .wrap #status-options.active {
  opacity: 1;
  visibility: visible;
  margin: 75px 0 0 0;
}
@media screen and (max-width: 735px) {
  #frame #sidepanel #profile .wrap #status-options.active {
    margin-top: 62px;
  }
}
#frame #sidepanel #profile .wrap #status-options:before {
  content: '';
  position: absolute;
  width: 0;
  height: 0;
  border-left: 6px solid transparent;
  border-right: 6px solid transparent;
  border-bottom: 8px solid #435f7a;
  margin: -8px 0 0 24px;
}
@media screen and (max-width: 735px) {
  #frame #sidepanel #profile .wrap #status-options:before {
    margin-left: 23px;
  }
}
#frame #sidepanel #profile .wrap #status-options ul {
  overflow: hidden;
  border-radius: 6px;
}
#frame #sidepanel #profile .wrap #status-options ul li {
  padding: 15px 0 30px 18px;
  display: block;
  cursor: pointer;
}
@media screen and (max-width: 735px) {
  #frame #sidepanel #profile .wrap #status-options ul li {
    padding: 15px 0 35px 22px;
  }
}
#frame #sidepanel #profile .wrap #status-options ul li:hover {
  background: #496886;
}
#frame #sidepanel #profile .wrap #status-options ul li span.status-circle {
  position: absolute;
  width: 10px;
  height: 10px;
  border-radius: 50%;
  margin: 5px 0 0 0;
}
@media screen and (max-width: 735px) {
  #frame #sidepanel #profile .wrap #status-options ul li span.status-circle {
    width: 14px;
    height: 14px;
  }
}
#frame #sidepanel #profile .wrap #status-options ul li span.status-circle:before {
  content: '';
  position: absolute;
  width: 14px;
  height: 14px;
  margin: -3px 0 0 -3px;
  background: transparent;
  border-radius: 50%;
  z-index: 0;
}
@media screen and (max-width: 735px) {
  #frame #sidepanel #profile .wrap #status-options ul li span.status-circle:before {
    height: 18px;
    width: 18px;
  }
}
#frame #sidepanel #profile .wrap #status-options ul li p {
  padding-left: 12px;
}
@media screen and (max-width: 735px) {
  #frame #sidepanel #profile .wrap #status-options ul li p {
    display: none;
  }
}
#frame #sidepanel #profile .wrap #status-options ul li#status-online span.status-circle {
  background: #2ecc71;
}
#frame #sidepanel #profile .wrap #status-options ul li#status-online.active span.status-circle:before {
  border: 1px solid #2ecc71;
}
#frame #sidepanel #profile .wrap #status-options ul li#status-away span.status-circle {
  background: #f1c40f;
}
#frame #sidepanel #profile .wrap #status-options ul li#status-away.active span.status-circle:before {
  border: 1px solid #f1c40f;
}
#frame #sidepanel #profile .wrap #status-options ul li#status-busy span.status-circle {
  background: #e74c3c;
}
#frame #sidepanel #profile .wrap #status-options ul li#status-busy.active span.status-circle:before {
  border: 1px solid #e74c3c;
}
#frame #sidepanel #profile .wrap #status-options ul li#status-offline span.status-circle {
  background: #95a5a6;
}
#frame #sidepanel #profile .wrap #status-options ul li#status-offline.active span.status-circle:before {
  border: 1px solid #95a5a6;
}
#frame #sidepanel #profile .wrap #expanded {
  padding: 100px 0 0 0;
  display: block;
  line-height: initial !important;
}
#frame #sidepanel #profile .wrap #expanded label {
  float: left;
  clear: both;
  margin: 0 8px 5px 0;
  padding: 5px 0;
}
#frame #sidepanel #profile .wrap #expanded input {
  border: none;
  margin-bottom: 6px;
  background: #32465a;
  border-radius: 3px;
  color: #f5f5f5;
  padding: 7px;
  width: calc(100% - 43px);
}
#frame #sidepanel #profile .wrap #expanded input:focus {
  outline: none;
  background: #435f7a;
}
#frame #sidepanel #search {
  border-top: 1px solid #32465a;
  border-bottom: 1px solid #32465a;
  font-weight: 300;
}
@media screen and (max-width: 735px) {
  #frame #sidepanel #search {
    display: none;
  }
}
#frame #sidepanel #search label {
  position: absolute;
  margin: 10px 0 0 20px;
}
#frame #sidepanel #search input {
  font-family: "proxima-nova",  "Source Sans Pro", sans-serif;
  padding: 10px 0 10px 46px;
  width: calc(100% - 25px);
  border: none;
  background: #32465a;
  color: #f5f5f5;
}
#frame #sidepanel #search input:focus {
  outline: none;
  background: #435f7a;
}
#frame #sidepanel #search input::-webkit-input-placeholder {
  color: #f5f5f5;
}
#frame #sidepanel #search input::-moz-placeholder {
  color: #f5f5f5;
}
#frame #sidepanel #search input:-ms-input-placeholder {
  color: #f5f5f5;
}
#frame #sidepanel #search input:-moz-placeholder {
  color: #f5f5f5;
}
#frame #sidepanel #contacts {
  height: calc(100% - 177px);
  overflow-y: scroll;
  overflow-x: hidden;
}
@media screen and (max-width: 735px) {
  #frame #sidepanel #contacts {
    height: calc(100% - 149px);
    overflow-y: scroll;
    overflow-x: hidden;
  }
  #frame #sidepanel #contacts::-webkit-scrollbar {
    display: none;
  }
}
#frame #sidepanel #contacts.expanded {
  height: calc(100% - 334px);
}
#frame #sidepanel #contacts::-webkit-scrollbar {
  width: 8px;
  background: #2c3e50;
}
#frame #sidepanel #contacts::-webkit-scrollbar-thumb {
  background-color: #243140;
}
#frame #sidepanel #contacts ul li.contact {
  position: relative;
  padding: 10px 0 15px 0;
  font-size: 0.9em;
  cursor: pointer;
}
@media screen and (max-width: 735px) {
  #frame #sidepanel #contacts ul li.contact {
    padding: 6px 0 66px 8px;
  }
}
#frame #sidepanel #contacts ul li.contact:hover {
  background: #32465a;
}
#frame #sidepanel #contacts ul li.contact.active {
  background: #32465a;
  border-right: 5px solid #435f7a;
}
#frame #sidepanel #contacts ul li.contact.active span.contact-status {
  border: 2px solid #32465a !important;
}
#frame #sidepanel #contacts ul li.contact .wrap {
  width: 88%;
  margin: 0 auto;
  position: relative;
}
@media screen and (max-width: 735px) {
  #frame #sidepanel #contacts ul li.contact .wrap {
    width: 100%;
  }
}
#frame #sidepanel #contacts ul li.contact .wrap span {
  position: absolute;
  left: 0;
  margin: -2px 0 0 -2px;
  width: 10px;
  height: 10px;
  border-radius: 50%;
  border: 2px solid #2c3e50;
  background: #95a5a6;
}
#frame #sidepanel #contacts ul li.contact .wrap span.online {
  background: #2ecc71;
}
#frame #sidepanel #contacts ul li.contact .wrap span.away {
  background: #f1c40f;
}
#frame #sidepanel #contacts ul li.contact .wrap span.busy {
  background: #e74c3c;
}
#frame #sidepanel #contacts ul li.contact .wrap img {
  width: 50px;
  border-radius: 50%;
  float: left;
  margin-right: 10px;
}
@media screen and (max-width: 735px) {
  #frame #sidepanel #contacts ul li.contact .wrap img {
    margin-right: 0px;
  }
}
#frame #sidepanel #contacts ul li.contact .wrap .meta {
  padding: 5px 0 0 0;
}
@media screen and (max-width: 735px) {
  #frame #sidepanel #contacts ul li.contact .wrap .meta {
    display: none;
  }
}
#frame #sidepanel #contacts ul li.contact .wrap .meta .name {
  font-weight: 600;
}
#frame #sidepanel #contacts ul li.contact .wrap .meta .preview {
  margin: 5px 0 0 0;
  padding: 0 0 1px;
  font-weight: 400;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  -moz-transition: 1s all ease;
  -o-transition: 1s all ease;
  -webkit-transition: 1s all ease;
  transition: 1s all ease;
}
#frame #sidepanel #contacts ul li.contact .wrap .meta .preview span {
  position: initial;
  border-radius: initial;
  background: none;
  border: none;
  padding: 0 2px 0 0;
  margin: 0 0 0 1px;
  opacity: .5;
}
#frame #sidepanel #bottom-bar {
  position: absolute;
  width: 100%;
  bottom: 0;
}
#frame #sidepanel #bottom-bar button {
  float: left;
  border: none;
  width: 50%;
  padding: 10px 0;
  background: #32465a;
  color: #f5f5f5;
  cursor: pointer;
  font-size: 0.85em;
  font-family: "proxima-nova",  "Source Sans Pro", sans-serif;
}
@media screen and (max-width: 735px) {
  #frame #sidepanel #bottom-bar button {
    float: none;
    width: 100%;
    padding: 15px 0;
  }
}
#frame #sidepanel #bottom-bar button:focus {
  outline: none;
}
#frame #sidepanel #bottom-bar button:nth-child(1) {
  border-right: 1px solid #2c3e50;
}
@media screen and (max-width: 735px) {
  #frame #sidepanel #bottom-bar button:nth-child(1) {
    border-right: none;
    border-bottom: 1px solid #2c3e50;
  }
}
#frame #sidepanel #bottom-bar button:hover {
  background: #435f7a;
}
#frame #sidepanel #bottom-bar button i {
  margin-right: 3px;
  font-size: 1em;
}
@media screen and (max-width: 735px) {
  #frame #sidepanel #bottom-bar button i {
    font-size: 1.3em;
  }
}
@media screen and (max-width: 735px) {
  #frame #sidepanel #bottom-bar button span {
    display: none;
  }
}
#frame .content {
  float: right;
  width: 60%;
  height: 100%;
  overflow: hidden;
  position: relative;
}
@media screen and (max-width: 735px) {
  #frame .content {
    width: calc(100% - 100px);
    min-width: 300px !important;
  }
}
@media screen and (min-width: 900px) {
  #frame .content {
    width: calc(100% - 340px);
  }
}
#frame .content .contact-profile {
  width: 100%;
  height: 80px;
  line-height: 80px;
  background: #f5f5f5;
}
#frame .content .contact-profile img {
  width: 60px;
  border-radius: 50%;
  float: left;
  margin: 9px 12px 0 9px;
}
#frame .content .contact-profile p {
  float: left;
  font-size: 18px;
}
#frame .content .contact-profile .social-media {
  float: right;
}
#frame .content .contact-profile .social-media i {
  margin-left: 14px;
  cursor: pointer;
}
#frame .content .contact-profile .social-media i:nth-last-child(1) {
  margin-right: 20px;
}
#frame .content .contact-profile .social-media i:hover {
  color: #435f7a;
}
#frame .content .messages {
  height: auto;
  min-height: calc(100% - 173px);
  max-height: calc(100% - 173px);
  overflow-y: scroll;
  overflow-x: hidden;
  width: 100%;
}
@media screen and (max-width: 735px) {
  #frame .content .messages {
    max-height: calc(100% - 105px);
  }
}
#frame .content .messages::-webkit-scrollbar {
  width: 8px;
  background: transparent;
}
#frame .content .messages::-webkit-scrollbar-thumb {
  background-color: rgba(0, 0, 0, 0.3);
}
#frame .content .messages ul li {
  display: inline-block;
  clear: both;
  float: left;
  margin: 15px 15px 5px 15px;
  width: calc(100% - 25px);
  font-size: 0.9em;
}
#frame .content .messages ul li:nth-last-child(1) {
  margin-bottom: 20px;
}
#frame .content .messages ul li.sent img {
  margin: 6px 8px 0 0;
}
#frame .content .messages ul li.sent p {
  background: #435f7a;
  color: #f5f5f5;
}
#frame .content .messages ul li.replies img {
  float: right;
  margin: 6px 0 0 8px;
}
#frame .content .messages ul li.replies p {
  background: #f5f5f5;
  float: right;
}
#frame .content .messages ul li img {
  width: 42px;
  border-radius: 50%;
  float: left;
}
#frame .content .messages ul li p {
  display: inline-block;
  padding: 10px 15px;
  border-radius: 20px;
  max-width: 300px;
  line-height: 130%;
  font-size: 18px;
}
@media screen and (min-width: 735px) {
  #frame .content .messages ul li p {
    max-width: 300px;
  }
}
#frame .content .message-input {
  position: absolute;
  bottom: 0;
  width: 100%;
  z-index: 99;
}
#frame .content .message-input .wrap {
  position: relative;
}
#frame .content .message-input .wrap input {
  font-family: "proxima-nova",  "Source Sans Pro", sans-serif;
  float: left;
  border: none;
  width: calc(100% - 90px);
  padding: 11px 32px 10px 8px;
  font-size: 1.8em;
  color: #32465a;
}
@media screen and (max-width: 735px) {
  #frame .content .message-input .wrap input {
    padding: 15px 32px 16px 8px;
  }
}
#frame .content .message-input .wrap input:focus {
  outline: none;
}
#frame .content .message-input .wrap .attachment {
  position: absolute;
  right: 60px;
  z-index: 4;
  margin-top: 10px;
  font-size: 1.8em;
  color: #435f7a;
  opacity: .5;
  cursor: pointer;
}
@media screen and (max-width: 735px) {
  #frame .content .message-input .wrap .attachment {
    margin-top: 19px;
    right: 65px;
  }
}
#frame .content .message-input .wrap .attachment:hover {
  opacity: 1;
}
#frame .content .message-input .wrap button {
  float: right;
  border: none;
  width: 50px;
  padding: 12px 0;
  cursor: pointer;
  background: #32465a;
  color: #f5f5f5;
}
@media screen and (max-width: 735px) {
  #frame .content .message-input .wrap button {
    padding: 21px 0;
  }
}
#frame .content .message-input .wrap button:hover {
  background: #435f7a;
}
#frame .content .message-input .wrap button:focus {
  outline: none;
}

.fa {
  font-size: 1.5em !important;
}

p {
  font-size: 16px;
}

button {
  border: 1px solid #000;
  padding: 10px;
  background-color: #f0f0f0;
  text-decoration: none;
  display: inline-block;
}

button:active,
button:focus {
  outline: none;
  border: none;
}

    </style>
  </head>

<body>
  <div id="frame">
    <div id="sidepanel">
      <div id="profile">
        <div class="wrap">
          <img id="profile-img" class="offline" src="{{ user.user.pfp.url }}" alt="" style="width: 60px;height: 60px;border-radius: 50%;" />
          <p>{{ user.user.last_name }}, {{ user.user.first_name }} {{ user.user.middle_name }}</p>
          <i class="fa fa-chevron-down expand-button" aria-hidden="true"></i>
          <div id="status-options">
            <ul>
              <li id="status-online" class="active"><span class="status-circle"></span> <p>Online</p></li>
              <li id="status-away"><span class="status-circle"></span> <p>Away</p></li>
              <li id="status-busy"><span class="status-circle"></span> <p>Busy</p></li>
              <li id="status-offline"><span class="status-circle"></span> <p>Offline</p></li>
            </ul>
          </div>
          <div id="expanded">
            <label for="twitter"><i class="fa fa-facebook fa-fw" aria-hidden="true"></i></label>
            <input name="twitter" type="text" value="mikeross" />
            <label for="twitter"><i class="fa fa-twitter fa-fw" aria-hidden="true"></i></label>
            <input name="twitter" type="text" value="ross81" />
            <label for="twitter"><i class="fa fa-instagram fa-fw" aria-hidden="true"></i></label>
            <input name="twitter" type="text" value="mike.ross" />
          </div>
        </div>
      </div>
      <!-- <div id="" style="background-color: whitesmoke;">
        
        <label for=""><i class="fa fa-search" aria-hidden="true"></i></label>
        <input type="text" placeholder="Search contacts..." />
      </div> -->
      <div id="contacts" style="background-color: #2C3E50;border-radius: 1px;" class="mt-5">
        <ul class="nav nav-tabs row no-gutters g-0" role="tablist">
          <li class="nav-item col-6 btn chat-type-change friend-chat-tab" id="Friend Conversations">
            <a class="nav-link font-weight-bold" aria-current="page" href="#tabContent1"data-toggle="tab">Friends</a>
          </li>
          <li class="nav-item col-6 btn chat-type-change group-chat-tab" id="Group Conversations">
            <a class="nav-link font-weight-bold" aria-current="page" href="#tabContent2" data-toggle="tab">Groups</a>
          </li>
        </ul>
        <!-- <p class="h4 text-center text-white p-3" style="border: none;background-color: #121a21;">Friends</p> -->
        <div class="tab-content">
          <div class="tab-pane" id="tabContent1">
            <ul class="mt-2">
              {% for friend in friends_list %}

              {% if friend.user2 == user %}
              <li class="contact friend-conversation" data-friend-i="{{ friend.user1.user.instagram }}" data-friend-t="{{ friend.user1.user.twitter }}" data-friend-f="{{ friend.user1.user.facebook }}" data-friend-l="{{ friend.user1.user.linkedin }}" data-friend-user-fullname="{{ friend.user1.user.get_full_name }}" data-friend-user="{{ friend.user1.user.pfp.url }}" data-friend-username="{{ friend.user1.user.username }}" id="contact-{{ friend.user1.user.username }}">
                <div class="wrap">
                  <img src="{{ friend.user1.user.pfp.url }}" alt="" style="border-radius: 50%;width: 60px;height: 60px;"/>
                  <div class="meta">
                    <p class="name">{{ friend.user1.user.get_full_name }}</p>
                    <p class="last_message text-info" style="font-style: italic;" id="last_message_{{ friend.user1.user.username }}">
                      {% if friend.last_chat_with_conn.content %}
                      
                      {% if friend.last_chat_with_conn.content|length > 20 %}
                      {{ friend.last_chat_with_conn.content|slice:":20" }}.....
                      {% else %}
                      {{ friend.last_chat_with_conn.content }}
                      {% endif %}

                      {% elif friend.last_chat_with_conn.file_content %}
                      File 📁
                      {% elif not friend.last_chat_with_conn.file_content and not friend.last_chat_with_conn.content%}
                      Send a message
                      {% endif %}
                    </p>
                  </div>
                </div>
              </li>
              {% elif friend.user1 == user %}
              <li class="contact friend-conversation" data-friend-i="{{ friend.user2.user.instagram }}" data-friend-t="{{ friend.user2.user.twitter }}" data-friend-f="{{ friend.user2.user.facebook }}" data-friend-l="{{ friend.user2.user.linkedin }}" data-friend-user-fullname="{{ friend.user2.user.get_full_name }}" data-friend-user="{{ friend.user2.user.pfp.url }}" data-friend-username="{{ friend.user2.user.username }}" id="contact-{{ friend.user2.user.username }}">
                <div class="wrap">
                  <img src="{{ friend.user2.user.pfp.url }}" alt="" style="border-radius: 50%;width: 60px;height: 60px;"/>
                  <div class="meta">
                    <p class="name">{{ friend.user2.user.get_full_name }}</p>
                    <p class="last_message text-info" style="font-style: italic;" id="last_message_{{ friend.user2.user.username }}">
                      {% if friend.last_chat_with_conn.content %}
                      
                      {% if friend.last_chat_with_conn.content|length > 20 %}
                      {{ friend.last_chat_with_conn.content|slice:":20" }}.....
                      {% else %}
                      {{ friend.last_chat_with_conn.content }}
                      {% endif %}

                      {% elif friend.last_chat_with_conn.file_content %}
                      File 📁
                      {% elif not friend.last_chat_with_conn.file_content and not friend.last_chat_with_conn.content%}
                      Send a message
                      {% endif %}
                    </p>
                  </div>
                </div>
              </li>
              {% endif %}
              {% endfor %}
            </ul>
          </div>
          
          <div class="tab-pane" id="tabContent2">
            <ul class="mt-2">
              {% for group in groups %}
              <li class="contact group-conversation" id="contact-{{ group.name }}" data-group-pk="{{ group.pk }}" data-group-members="{{ group.members.all }}" data-group-name="{{ group.name }}" data-group-desc="{{ group.description}}" data-members-count="{{ group.members_count }}">
                <div class="wrap">
                  
                  <img src="{% static 'images/group.jpg' %}" alt="" style="border-radius: 50%;width: 60px;height: 60px;"/>
                  <div class="meta">
                    <p class="name" id="group-name" >{{ group.name }}</p>
                    <!-- <p class="preview" style="text-wrap: wrap;">{{ group.description }}</p> -->
                  </div>
                </div>
              </li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>
      <div id="bottom-bar">
        <button id="addcontact"><i class="fa fa-user-plus fa-fw" aria-hidden="true"></i> <span>Add contact</span></button>
        <button id="settings"><i class="fa fa-cog fa-fw" aria-hidden="true"></i> <span>Settings</span></button>
      </div>
    </div>
    <div class="content" id="content-1" style="display: none;">
      <div class="contact-profile">
        <img src="" alt="" id="recipient_pfp" />
        <p id="recipient_username"></p>
        <!-- <p id="members-count-slot" style="display: block;"></p> -->
        <div class="social-media">
          <a href="" id="recipient_linkedin" style="display: none;">
            <i class="fa fa-linkedin" aria-hidden="true"></i>
          </a>
          <a href="" id="recipient_facebook" style="display: none;">
            <i class="fa fa-facebook" aria-hidden="true"></i>
          </a>
          <a href="" id="recipient_twitter" style="display: none;">
            <i class="fa fa-twitter" aria-hidden="true"></i>
          </a>
          <a href="" id="recipient_instagram" style="display: none;">
            <i class="fa fa-instagram" aria-hidden="true"></i>
          </a>
        </div>
      </div>
      <div class="messages">
        <div class="floating d-flex justify-content-center" id="floating">
        </div>
        <ul id="chat-log">
        </ul>
      </div>
      <!-- <div id="scrollToBottomIcon">
        <i class="fa fa-arrow-circle-down" style="color: #2C3E50;padding: 10px;"></i>
    </div> -->
      <div class="message-input" style="display: none;">
        <input type="file" name="file-message" id="file-msg1" hidden>
        <div class="wrap">
        <input type="text" hidden value="normal" id="message_type">
        <input id="chat-message-input1" type="text" placeholder="Write your message..." />
        <i class="fa fa-paperclip attachment" id="clip-1" aria-hidden="true"></i>
        <button id="chat-message-submit1" class="submit">
          <i class="fa fa-paper-plane" aria-hidden="true"></i>
        </button>
        </div>
      </div>
    </div>
    <div class="content" id="content-2" style="display: none;">
      <div class="contact-profile" id="contact-profile-1">
        <img src="" alt="" id="group_pfp" />
        <p id="group_name"></p>
        <p id="members-count-slot" style="display: block;"></p>
      </div>
      <div class="contact-profile" id="contact-profile-2"></div>
      <div class="messages">
        <div class="floating d-flex justify-content-center" id="floating">
        </div>
        <ul id="chat-log-2">
        </ul>
      </div>
      <div class="message-input" style="display: none;">
        <input type="file" name="file-message" id="file-msg2" hidden>
        <div class="wrap">
        <input type="text" hidden value="normal" id="message_type2">
        <input id="chat-message-input2" type="text" placeholder="Write your message..." />
        <i class="fa fa-paperclip attachment" aria-hidden="true" id="clip-2"></i>
        <button id="chat-message-submit2" class="submit">
          <i class="fa fa-paper-plane" aria-hidden="true"></i>
        </button>
        </div>
      </div>
    </div>
  </div>

<script src="{% static 'chat/js/main.js' %}"></script>
<script src="{% static 'chat/js/reconnecting-websocket.js' %}"></script>


<script>

function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

  var insertedTaggedMessage
    document.getElementsByClassName('friend-chat-tab')[0].addEventListener('click', function () {
      document.getElementById('content-2').style.display = 'none';
    })
    var username = "{{ username }}"
  oldFriends = [];
  oldSockets = [];


  function handleFriendClick() {
    var fileMsg = document.querySelector('#file-msg1')
    var fileIcon = document.querySelector('#clip-1')
    var messageType = document.getElementById('message_type')
    messageType.value = 'normal';

    function removeTaggedMessage() {
      var parentMessageContent;
      document.getElementById('chat-message-input1').value = '';
      if (insertedTaggedMessage) {
        insertedTaggedMessage.parentNode.removeChild(insertedTaggedMessage); 
        insertedTaggedMessage = null;
        messageType.value = 'normal';
      }
    }

    removeTaggedMessage()

    if (oldSockets.length > 0) {
      var previousSocket = oldSockets[oldSockets.length-1];
      previousSocket.close()
    }

    var friendsChatSocket = new ReconnectingWebSocket(
    'ws://' + window.location.host + '/ws/chat/friends/');
    friendsChatSocket.debug = false;
    oldSockets.push(friendsChatSocket)

    var friendUsername = $(this).data('friend-username');
    var content1 = document.getElementById('content-1');
    var conversation = document.getElementById(`last_message_${friendUsername}`)
    content1.style.display = 'block';

    var floating = content1.querySelector('#floating');
    floatingClass = content1.querySelector('.floating')
    floatingClass.innerHTML = ''
    var addedTimestamps = []
    var chatLog = content1.querySelector("#chat-log");
    var username = "{{ username }}";
    oldFriends.push(friendUsername)
    
    chatLog.innerHTML = '';
    content1.querySelector('.message-input').style.display = 'inline';    

    friendsChatSocket.onopen = function(e) {
      fetchMessages(friendUsername);
      
    };
    

    $(this).removeClass('active');
    var friendUserPfp = $(this).data('friend-user');
    var friendUserFullname = $(this).data('friend-user-fullname');
    var friendUserInstagram = $(this).data('friend-i');
    var friendUserTwitter = $(this).data('friend-t');
    var friendUserFacebook = $(this).data('friend-f');
    var friendUserLinkedln = $(this).data('friend-l');

    var recipientPfpImg = content1.querySelector("#recipient_pfp");
    var recipientUsernameSlot = content1.querySelector("#recipient_username");
    var recipientInstagramSlot = content1.querySelector("#recipient_instagram")
    var recipientFacebookSlot = content1.querySelector("#recipient_facebook")
    var recipientTwitterSlot = content1.querySelector("#recipient_twitter")
    var recipientLinkedlnSlot = content1.querySelector("#recipient_linkedin")


    if (friendUserInstagram && friendUserInstagram.length > 22) {
      recipientInstagramSlot.style.display = 'inline';
    }
  
    if (friendUserTwitter && friendUserTwitter.length > 20) {
      recipientTwitterSlot.style.display = 'inline';
    }

    if (friendUserFacebook && friendUserFacebook.length > 21 ) {
      recipientFacebookSlot.style.display = 'inline';
    }

    if (friendUserLinkedln && friendUserLinkedln.length > 21) {
      recipientLinkedlnSlot.style.display = 'inline';
    }

    recipientPfpImg.style.height = "60px";
    recipientPfpImg.style.width = "60px";
    recipientPfpImg.src = friendUserPfp;
    recipientUsernameSlot.textContent = friendUserFullname;
    recipientInstagramSlot.href = friendUserInstagram;
    recipientFacebookSlot.href = friendUserFacebook;
    recipientTwitterSlot.href = friendUserTwitter;
    recipientLinkedlnSlot.href = friendUserLinkedln;    

    

    friendsChatSocket.onmessage = function(e) {

var data = JSON.parse(e.data);



if (data['command'] === 'messages') {
  
  content1.querySelector('#chat-log').innerHTML = '';
  var conversation = document.getElementById(`last_message_${friendUsername}`)
  for (let i = 0; i < data['messages'].length; i++) {
    if (data['messages'][i].sender === username || data['messages'][i].recipient === username) {
      if (data['messages'][data['messages'].length-1].content) {

        if (data['messages'][data['messages'].length-1].content.length < 21) {
        conversation.textContent = data['messages'][data['messages'].length-1].content
      }
      else {
        conversation.textContent = data['messages'][data['messages'].length-1].content.slice(0, 20) + "....." 
      }
      }
      else if (!data['messages'][data['messages'].length-1].content) {
        // var conversation = document.getElementById(`last_message_${friendUsername}`)
        conversation.textContent = 'File 📁'
      }
    }
    if (typeof data['messages'][i].tagged_pk === 'undefined') {
      
      if (data['messages'][i].sender === username) {
        senderMessages(data['messages'][i])
      }
      else if (data['messages'][i].recipient === username) {
        receivedMessage(data['messages'][i])
      }
      
    } 
    if (typeof data['messages'][i].tagged_pk !== 'undefined') {
      
      if (data['messages'][i].sender === username) {
        senderTaggedMessages(data['messages'][i])
      }
      else if (data['messages'][i].recipient === username) {
        receivedTaggedMessages(data['messages'][i])
      }
    } 
      
  };
} 
else if (data['command'] === 'new_message') {
  if (data['message'].sender === username || data['message'].sender === friendUsername) {
    var conversation = document.getElementById(`last_message_${friendUsername}`)
    // else if (data['message'].content) {
        if (data['message'].content.length < 21) {
        conversation.textContent = data['message'].content
        }
        else if (data['message'].content) {
          conversation.textContent = data['message'].content.slice(0, 20) + "....." 
        }
    // }
  }
  if (data['message'].sender === username) {
    content1.querySelector('.floating').innerHTML = ''; 
  }
  
      if (data['message'].sender === username ) {
        senderMessages(data['message']);
      }
      
      else if (data['message'].recipient === username && data['message'].sender === oldFriends[oldFriends.length -1]) {
        receivedMessage(data['message'])
      }

      if (data['message'].recipient === username && data['message'].sender === oldFriends[oldFriends.length -1]) {
        
        createNewMessageNotif(username, data['message'].pk)
      }
      else if (data['message'].recipient === username && data['message'].sender !== oldFriends[oldFriends.length -1]) {

      }
}

else if (data['command'] === 'tag_message') {
  if (data['message'].sender === username || data['message'].sender === friendUsername) {
    var conversation = document.getElementById(`last_message_${friendUsername}`)
    // else if (data['message'].content) {
        if (data['message'].content.length < 21) {
        conversation.textContent = data['message'].content
        }
        else if (data['message'].content) {
          conversation.textContent = data['message'].content.slice(0, 20) + "....." 
        }
    // }
  }
  if (data['message'].sender === username) {
    content1.querySelector('.floating').innerHTML = ''; 
  }
  
      if (data['message'].sender === username ) {
        senderTaggedMessages(data['message']);
      }
      
      else if (data['message'].recipient === username && data['message'].sender === oldFriends[oldFriends.length -1]) {
        receivedTaggedMessages(data['message'])
      }

      if (data['message'].recipient === username && data['message'].sender === oldFriends[oldFriends.length -1]) {
        
        createNewMessageNotif(username, data['message'].pk)
      }
      else if (data['message'].recipient === username && data['message'].sender !== oldFriends[oldFriends.length -1]) {

      }
}

else if (data['command'] === 'new_file_normal') {
  if (data['message'].sender === username) {
    floatingClass.innerHTML = ''; 
  }
      if (data['message'].sender === username || data['message'].sender === friendUsername) {
        var conversation = document.getElementById(`last_message_${friendUsername}`)
        conversation.textContent = 'File 📁'
      }
  
      if (data['message'].sender === username) {
        senderMessages(data['message']);
      }
      
      else if (data['message'].recipient === username && data['message'].sender === oldFriends[oldFriends.length -1]) {
        receivedMessage(data['message'])        
      }

      if (data['message'].recipient === username && data['message'].sender === oldFriends[oldFriends.length -1]) {
        createNewMessageNotif(username, data['message'].pk)
      }
    
    
}

else if (data['command'] === 'new_file_tagged') {
  if (data['message'].sender === username) {
    floatingClass.innerHTML = ''; 
  }
      if (data['message'].sender === username || data['message'].sender === friendUsername) {
        var conversation = document.getElementById(`last_message_${friendUsername}`)
        conversation.textContent = 'File 📁'
      }
  
      if (data['message'].sender === username) {
        senderTaggedMessages(data['message']);
      }
      
      else if (data['message'].recipient === username && data['message'].sender === oldFriends[oldFriends.length -1]) {
        receivedTaggedMessages(data['message'])
        
      }

      if (data['message'].recipient === username && data['message'].sender === oldFriends[oldFriends.length -1]) {
        createNewMessageNotif(username, data['message'].pk)
      }
    
    
}



};
    function sendMessage() {
      if (messageType.value === 'normal') {
        var messageInputDom = document.querySelector('#chat-message-input1');
        var message = messageInputDom.value;
        friendsChatSocket.send(JSON.stringify({
        'command': 'new_message',
        'message': message,
        'type': 'normal',
        'from': username,
        'to': friendUsername
      }));
      messageInputDom.value = '';
      }

      else if (messageType.value === 'tagged') {
        var messageInputDom = document.querySelector('#chat-message-input1');
        var message = messageInputDom.value;
        friendsChatSocket.send(JSON.stringify({
          'command': 'tag_message',
          'from': username,
          'type': 'tagged',
          'to': friendUsername,
          'parentMessage': parentMessageContent['pk'],
          'message': message
        }));
        messageInputDom.value = '';
        removeTaggedMessage()
      }

      else {
        console.log('This instance is not pre-defined.');
      }
      
    }


    friendsChatSocket.onclose = function(e) {
      console.error('Chat socket closed unexpectedly');
    };

    document.querySelector('#chat-message-input1').onkeyup = function(e) {
      if (e.keyCode === 13) {  
        document.querySelector('#chat-message-submit1').click();
      }
    };

    document.querySelector('#chat-message-submit1').onclick = function(e) {
      sendMessage()
    };

    
    fileIcon.onclick = function(e) {
      fileMsg.click();
    }

    fileMsg.onchange = function(e) {
      e.preventDefault()

      
      var fileMessageType;
      if (messageType.value === 'normal') {
        var sendFileUrl = "{% url 'chat:send_file_msg' sender=0 recipient=1 %}".replace('0', username).replace('1', friendUsername); 
        fileMessageType = 'normal';
      }
      else if (messageType.value === 'tagged') {
        var sendFileUrl = "{% url 'chat:send_file_msg_with_parent' sender=0 recipient=1 parent_message=2 %}".replace('0', username).replace('1', friendUsername).replace('2', parentMessageContent.pk); 
        fileMessageType = 'tagged';
      }
      var file = fileMsg.files[0];
      var formData = new FormData();
      formData.append('file', file)
      $.ajax({
        processData: false,
        contentType: false,
        async: false,
        type: 'POST',
        cache: false,
        url: sendFileUrl,
        data: formData,
        headers: {
          'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(response) {
          friendsChatSocket.send(JSON.stringify({
            'command': `new_file_${fileMessageType}`,
            'message': response,
            'sender': username,
            'message_type': fileMessageType,
            'recipient': friendUsername
          }));
          // fileMsg.value = '';
           if (username === response.message_recipient) {
            receivedFileMessage(response)
          } 
          removeTaggedMessage()
        }
        
      })
    }

    function fetchMessages(friendUsername) {
      
      friendsChatSocket.send(JSON.stringify({
        'command': 'fetch_messages',
        'sender': username,
        'recipient': friendUsername
      }));
    }


    function senderMessages(data) {
      var sender = data['sender'];
      var msgListTag = document.createElement('li');
      msgListTag.style.position = 'relative'
      var imgTag = document.createElement('img');
      

      var time = document.createElement('p');
      time.style.zIndex = '10000000'
      time.className = 'time';
      time.style.padding = '0 10px'
      time.textContent = new Date(data['timestamp']).toLocaleString()
      time.style.float = 'right';
      time.style.fontStyle = 'italic';
      time.style.marginTop = '-15px';
      time.style.marginRight = '60px';
      time.style.fontSize = '15px';
      time.style.color = 'green'
      
      imgTag.src = data['sender_pfp_url'];
      imgTag.style.width = "30px";
      imgTag.style.height = "30px";
      imgTag.style.borderRadius = "50%";

      var svgElement = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      svgElement.setAttribute("xmlns", "http://www.w3.org/2000/svg");
      svgElement.setAttribute("height", "50");
      svgElement.setAttribute("width", "12");
      svgElement.style.float = 'right'
      svgElement.setAttribute('transform','translate(22,65)');
      svgElement.setAttribute("viewBox", "0 0 448 512");

      var pathElement = document.createElementNS("http://www.w3.org/2000/svg", "path");
      pathElement.setAttribute("d", "M201.4 342.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 274.7 86.6 137.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z");
      pathElement.setAttribute("fill", "#435F7A");

      svgElement.appendChild(pathElement);
      svgElement.style.marginTop = '-100px';
      svgElement.style.fontSize = '10px'
      
      if (sender !== username) {
        msgListTag.className = 'sent';
      } else {
      msgListTag.className = 'replies';
        
      }
      
      
      msgListTag.appendChild(imgTag);
      if (data['content']) {
        var pTag = document.createElement('p'); 
        pTag.textContent = data.content;
        pTag.style.padding = '15px 30px'
        pTag.style.wordWrap = 'break-word'
        pTag.id = 'original_' + `${data['pk']}`
        var dropdownWrapper = document.createElement('div');
        dropdownWrapper.className = 'dropdown';

        // svgElement.setAttribute('class', 'btn btn-secondary dropdown-toggle');
        svgElement.setAttribute('type', 'button');
        svgElement.setAttribute('id', 'dropdownMenuButton');
        svgElement.setAttribute('data-toggle', 'dropdown');
        svgElement.setAttribute('aria-haspopup', 'true');
        svgElement.setAttribute('aria-expanded', 'false');


        // Create the dropdown menu
        var dropdownMenu = document.createElement('div');
        dropdownMenu.className = 'dropdown-menu text-center';
        dropdownMenu.style.minWidth = '40px'
        dropdownMenu.setAttribute('aria-labelledby', 'dropdownMenuButton');

        var dropdownItem = document.createElement('i');
        dropdownItem.className = 'dropdown-item fa fa-reply text-center';
        dropdownItem.href = '#';

        dropdownMenu.appendChild(dropdownItem);

        dropdownMenu.addEventListener('click', function() { 
          if (data['content'].length > 15) {
            tagMessageAndFocus(data['content'].slice(0, 14) + '....')
          }

          else if (data['content'].length <= 15) {
            tagMessageAndFocus(data['content'])
          }
          parentMessageContent = data
        })

        dropdownWrapper.appendChild(svgElement);
        dropdownWrapper.appendChild(dropdownMenu);
        
        msgListTag.appendChild(pTag);
        pTag.appendChild(dropdownWrapper);

        
      }
      if (data['file_content'] !== null) {
        var pTag = document.createElement('button');
        var hrefLink = document.createElement('a')
        hrefLink.href = data['file_content'];
        hrefLink.textContent = 'View File'
        hrefLink.style.textDecoration = 'none'
        pTag.appendChild(hrefLink)
        pTag.style.padding = '10px 30px'
        pTag.id = 'original_' + `${data['pk']}`
        pTag.style.backgroundColor = 'white'
        pTag.style.float = 'right'
        pTag.style.borderRadius = '10px'
        pTag.style.border = '0px';
        pTag.style.marginBottom = '10px';
        pTag.style.fontSize = '20px'

        var dropdownWrapper = document.createElement('div');
        dropdownWrapper.className = 'dropdown';

        svgElement.setAttribute('type', 'button');
        svgElement.setAttribute('id', 'dropdownMenuButton');
        svgElement.setAttribute('data-toggle', 'dropdown');
        svgElement.setAttribute('aria-haspopup', 'true');
        svgElement.setAttribute('aria-expanded', 'false');

        var dropdownMenu = document.createElement('div');
        dropdownMenu.className = 'dropdown-menu text-center';
        dropdownMenu.style.minWidth = '40px'
        dropdownMenu.setAttribute('aria-labelledby', 'dropdownMenuButton');

        var dropdownItem = document.createElement('i');
        dropdownItem.className = 'dropdown-item fa fa-reply text-center';
        dropdownItem.href = '#';

        dropdownMenu.appendChild(dropdownItem);
        dropdownMenu.addEventListener('click', function() { 
          tagMessageAndFocus('File 📁')
          parentMessageContent = data;
        })

        dropdownWrapper.appendChild(svgElement);
        dropdownWrapper.appendChild(dropdownMenu);

        msgListTag.appendChild(pTag);
        pTag.appendChild(dropdownWrapper);
        }
        if ( data['recipient'] === friendUsername) {
        chatLog.appendChild(msgListTag); 
        }

          chatLog.appendChild(time)

        msgListTag.style.padding = '10px';

        svgElement.onclick = function(e) {
          
        }
      }
    

    function receivedMessage(data) {
      var sender = data['sender'];
      
      var msgListTag = document.createElement('li');
      msgListTag.style.position = 'relative'
      var imgTag = document.createElement('img');
      
      var time2 = document.createElement('p');
      time2.style.zIndex = '10000000'
      time2.className = 'time';
      time2.style.padding = '0px 10px'
      time2.textContent = new Date(data['timestamp']).toLocaleString()
      time2.style.float = 'left';
      time2.style.fontStyle = 'italic';
      time2.style.marginTop = '-15px';
      time2.style.marginLeft = '20px';
      time2.style.fontSize = '15px';
      time2.style.color = 'green'

      imgTag.src = data['sender_pfp_url'];
      imgTag.style.width = "30px";
      imgTag.style.height = "30px";
      imgTag.style.borderRadius = "50%";

      msgListTag.className = 'sent';

      var svgElement = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      svgElement.setAttribute("xmlns", "http://www.w3.org/2000/svg");
      svgElement.setAttribute("height", "50");
      svgElement.setAttribute("width", "12");
      svgElement.style.float = 'left';
      svgElement.setAttribute('transform','translate(-22,65)');
      svgElement.setAttribute("viewBox", "0 0 448 512");

      var pathElement = document.createElementNS("http://www.w3.org/2000/svg", "path");
      pathElement.setAttribute("d", "M201.4 342.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 274.7 86.6 137.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z");
      pathElement.setAttribute('fill', '#F5F5F5');

      svgElement.appendChild(pathElement);
      svgElement.style.marginTop = '-100px';
      svgElement.style.fontSize = '10px'


      msgListTag.appendChild(imgTag);
      if (data['content']) {
        var pTag = document.createElement('p'); 
        pTag.textContent = data.content;
        pTag.style.padding = '15px 30px'
        
        pTag.id = 'original_' + `${data['pk']}`
        pTag.style.wordWrap = 'break-word'
        // Create a Bootstrap dropdown wrapper
        var dropdownWrapper = document.createElement('div');
        dropdownWrapper.className = 'dropdown';

        // svgElement.setAttribute('class', 'btn btn-secondary dropdown-toggle');
        svgElement.setAttribute('type', 'button');
        svgElement.setAttribute('id', 'dropdownMenuButton');
        svgElement.setAttribute('data-toggle', 'dropdown');
        svgElement.setAttribute('aria-haspopup', 'true');
        svgElement.setAttribute('aria-expanded', 'false');


        // Create the dropdown menu
        var dropdownMenu = document.createElement('div');
        dropdownMenu.className = 'dropdown-menu text-center';
        dropdownMenu.style.minWidth = '40px'
        // dropdownMenu.style.padding = '0px'
        // dropdownMenu.style.margin = '0px'
        dropdownMenu.setAttribute('aria-labelledby', 'dropdownMenuButton');

        dropdownMenu.addEventListener('click', function() { 
          if (data['content'].length > 15) {
            tagMessageAndFocus(data['content'].slice(0, 14) + '....')
          }

          else if (data['content'].length <= 15) {
            tagMessageAndFocus(data['content'])
          }
          parentMessageContent = data
        })

        // Create dropdown item (you can customize this as needed)
        var dropdownItem = document.createElement('i');
        dropdownItem.className = 'dropdown-item fa fa-reply text-center';
        dropdownItem.href = '#';
        // dropdownItem.textContent = 'Tag';
        // dropdownItem.style.width = '40px';

        // Append dropdown item to the dropdown menu
        dropdownMenu.appendChild(dropdownItem);

        // Append dropdown toggle and menu to the dropdown wrapper
        dropdownWrapper.appendChild(svgElement);
        dropdownWrapper.appendChild(dropdownMenu);

        // Append the Bootstrap dropdown wrapper to the message
        // msgListTag.appendChild(dropdownWrapper);

        msgListTag.appendChild(pTag);
        pTag.appendChild(dropdownWrapper);
      }
      if (data['file_content'] !== null) {
        var pTag = document.createElement('button');
        var hrefLink = document.createElement('a')
        hrefLink.href = data['file_content'];
        hrefLink.textContent = 'View File'
        hrefLink.style.textDecoration = 'none'
        hrefLink.style.color = 'white'
        pTag.appendChild(hrefLink)
        pTag.style.backgroundColor = '#435F7A'
        pTag.id = 'original_' + `${data['pk']}`
        pTag.style.padding = '10px 30px'
        pTag.style.borderRadius = '10px'
        pTag.style.border = '0px';
        pTag.style.marginBottom = '10px';
        pTag.style.fontSize = '20px'
        // pTag.appendChild(svgElement);
        // svgElement.setAttribute('transform','translate(-22,88)');
        // msgListTag.appendChild(pTag);
        var dropdownWrapper = document.createElement('div');
        dropdownWrapper.className = 'dropdown';

        // svgElement.setAttribute('class', 'btn btn-secondary dropdown-toggle');
        svgElement.setAttribute('type', 'button');
        svgElement.setAttribute('id', 'dropdownMenuButton');
        svgElement.setAttribute('data-toggle', 'dropdown');
        svgElement.setAttribute('aria-haspopup', 'true');
        svgElement.setAttribute('aria-expanded', 'false');


        // Create the dropdown menu
        var dropdownMenu = document.createElement('div');
        dropdownMenu.className = 'dropdown-menu text-center';
        dropdownMenu.style.minWidth = '40px'
        // dropdownMenu.style.padding = '0px'
        // dropdownMenu.style.margin = '0px'
        dropdownMenu.setAttribute('aria-labelledby', 'dropdownMenuButton');

        dropdownMenu.addEventListener('click', function() { 
          tagMessageAndFocus('File 📁')
          parentMessageContent = data
        })

        // Create dropdown item (you can customize this as needed)
        var dropdownItem = document.createElement('i');
        dropdownItem.className = 'dropdown-item fa fa-reply text-center';
        dropdownItem.href = '#';
        // dropdownItem.textContent = 'Tag';
        // dropdownItem.style.width = '40px';

        // Append dropdown item to the dropdown menu
        dropdownMenu.appendChild(dropdownItem);

        // Append dropdown toggle and menu to the dropdown wrapper
        dropdownWrapper.appendChild(svgElement);
        dropdownWrapper.appendChild(dropdownMenu);

        // Append the Bootstrap dropdown wrapper to the message
        // msgListTag.appendChild(dropdownWrapper);

        msgListTag.appendChild(pTag);
        pTag.appendChild(dropdownWrapper);
      }
      
      chatLog.appendChild(msgListTag); 
      chatLog.appendChild(time2)
      msgListTag.style.padding = '10px';
    }
    
    function receivedFileMessage(response) {
      var sender = response.message_sender;
            
            var msgListTag = document.createElement('li');
            var imgTag = document.createElement('img');

            if (data['tagged_content']) {
            var tagBox = document.createElement('div');
            tagBox.style.cursor = 'pointer'
            tagBox.id =data['tagged_pk']
            tagBox.textContent = data['tagged_content']
            tagBox.style.padding = '10px 30px'
            tagBox.style.float = 'left'
            tagBox.style.border = 'none';
            tagBox.style.marginBottom = '10px';
            tagBox.style.fontSize = '20px'
            msgListTag.appendChild(tagBox)

            tagBox.addEventListener('click', function() {
        // Call a function to scroll to the tagged message
              gotoTaggedMessage(tagBox.id);
          });
          }

          else if (data['tagged_file_content'] !== null) {
            var tagBox = document.createElement('a');
            tagBox.style.cursor = 'pointer'
            tagBox.id =data['tagged_pk']
            tagBox.className = 'tag-box';
            // tagBox.href = data['tagged_file_content']
            tagBox.textContent = 'File 📁'
            tagBox.style.padding = '10px 30px'
            tagBox.style.float = 'left'
            tagBox.style.border = 'none';
            tagBox.style.marginBottom = '10px';
            tagBox.style.fontSize = '20px'
            msgListTag.appendChild(tagBox)

            tagBox.addEventListener('click', function() {
        // Call a function to scroll to the tagged message
              gotoTaggedMessage(tagBox.id);
          });
          }



            var pTag = document.createElement('img');
            pTag.style.width = '400px';
            pTag.src = response.file_url;
            pTag.style.height = '280px';
            pTag.style.borderRadius = '10px'
            pTag.style.marginBottom = '10px';
            var time2 = document.createElement('p');
            time2.style.zIndex = '10000000'
            time2.className = 'time';
            time2.style.padding = '0 10px'
            time2.textContent = new Date(response.timestamp).toLocaleString()
            time2.style.float = 'left';
            time2.style.fontStyle = 'italic';
            time2.style.marginTop = '-15px';
            time2.style.marginLeft = '20px';
            time2.style.fontSize = '15px';
            time2.style.color = 'green'
            
            
            pTag.src = response.file_url;
            imgTag.src = response.message_recipient_url;
            imgTag.style.width = "30px";
            imgTag.style.height = "30px";
            imgTag.style.borderRadius = "50%";
            msgListTag.appendChild(imgTag);
            msgListTag.appendChild(pTag);
            msgListTag.className = 'sent';
            if (username === response.message_recipient) {
              chatLog.appendChild(msgListTag); 
              chatLog.appendChild(time2)
              
            }
            // else if (username === response.message_sender){
            // }
            msgListTag.style.padding = '10px';
    }

    function createNewMessageNotif(recipientName, msgID) {
        var button = document.createElement('button');
        button.className = 'new-msg-btn button button-primary badge-pill floating-btn';
        button.style.padding = '0px 20px';
        button.style.height = '70px';
        button.style.width = '250px';
        button.style.fontFamily = "";
        button.id = `msg_${msgID}_notif`
        // button.style.display = 'none';
        button.style.whiteSpace = 'nowrap';

        // Create the span element
        var span = document.createElement('span');
        span.style.fontSize = '18px';
        span.textContent = 'New Message';
        var icon = document.createElement('i');
        icon.className = 'fa fa-arrow-circle-down';
        icon.style.fontSize = '15px';
        icon.style.margin = "0px 5px";

        button.appendChild(span);
        button.appendChild(icon);

        if (recipientName === username) {
          document.getElementsByClassName('floating')[0].innerHTML = ''
          floating.appendChild(button); 

          // Add click event listener to the button
          button.onclick = function (e) {
            floatingClass.innerHTML = '';
            // Specify that it is a new message
            var messageElements = document.getElementsByClassName('sent');
            if (messageElements.length > 0) {
                var messageElement = messageElements[messageElements.length - 1];

                // Apply the hovering effect immediately
                messageElement.style.backgroundColor = '#50C878'; // Set your preferred background color
                messageElement.style.padding = '10px';
                messageElement.style.borderRadius = '15px';
                messageElement.style.boxShadow = '0 8px 10px rgba(0, 0, 0, 0.1)';

                // Set a timeout to remove the styles after 5 seconds
                setTimeout(function () {
                    messageElement.style.backgroundColor = ''; // Reset the background color
                    messageElement.style.padding = '10px';
                    messageElement.style.borderRadius = '';
                    messageElement.style.boxShadow = '';
                    messageElement.style.height = '';
                }, 5000); // Adjust the time (in milliseconds) as needed

                if (messageElement) {
          // Scroll to the position of the message element
                  messageElement.scrollIntoView({
                      behavior: 'smooth',
                      block: 'start',
                  });
              }
            }
        };


        }

    }

    function senderTaggedMessages(data) {
      var sender = data['sender'];
      var msgListTag = document.createElement('li');
      msgListTag.style.position = 'relative'
      msgListTag.style.backgroundColor = '#DCDCDC'
      msgListTag.style.borderRadius = '10px'
      var imgTag = document.createElement('img');
      
      if (data['tagged_content']) {
        var tagBox = document.createElement('div');
        tagBox.style.cursor = 'pointer'
        tagBox.id = 'trigger_' + `${data['tagged_pk']}`
        tagBox.textContent = data['tagged_content']
        tagBox.style.padding = '10px 30px'
        tagBox.style.float = 'left'
        tagBox.style.border = 'none';
        tagBox.style.marginBottom = '10px';
        tagBox.style.fontSize = '20px'
        msgListTag.appendChild(tagBox)

        tagBox.addEventListener('click', function() {
        // Call a function to scroll to the tagged message
              gotoTaggedMessage(tagBox.id);
          });
      }

      else if (data['tagged_file_content'] !== null) {
        var tagBox = document.createElement('a');
        tagBox.style.cursor = 'pointer'
        tagBox.id ='trigger_' + `${data['tagged_pk']}`
        tagBox.className = 'tag-box';
        // tagBox.href = data['tagged_file_content']
        tagBox.textContent = 'File 📁'
        tagBox.style.padding = '10px 30px'
        tagBox.style.float = 'left'
        tagBox.style.border = 'none';
        tagBox.style.marginBottom = '10px';
        tagBox.style.fontSize = '20px'
        msgListTag.appendChild(tagBox)

        tagBox.addEventListener('click', function() {
        // Call a function to scroll to the tagged message
        gotoTaggedMessage(tagBox.id);
          });
      }

      var time = document.createElement('p');
      time.style.zIndex = '10000000'
      time.className = 'time';
      time.style.padding = '0 10px'
      time.textContent = new Date(data['timestamp']).toLocaleString()
      time.style.float = 'right';
      time.style.fontStyle = 'italic';
      // time.style.marginTop = '2px';
      time.style.marginRight = '60px';
      time.style.fontSize = '15px';
      time.style.color = 'green'
      
      imgTag.src = data['sender_pfp_url'];
      imgTag.style.width = "30px";
      imgTag.style.height = "30px";
      imgTag.style.borderRadius = "50%";

      var svgElement = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      svgElement.setAttribute("xmlns", "http://www.w3.org/2000/svg");
      svgElement.setAttribute("height", "50");
      svgElement.setAttribute("width", "12");
      svgElement.style.float = 'right'
      svgElement.setAttribute('transform','translate(22,65)');
      svgElement.setAttribute("viewBox", "0 0 448 512");

      var pathElement = document.createElementNS("http://www.w3.org/2000/svg", "path");
      pathElement.setAttribute("d", "M201.4 342.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 274.7 86.6 137.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z");
      pathElement.setAttribute("fill", "#435F7A");

      svgElement.appendChild(pathElement);
      svgElement.style.marginTop = '-100px';
      svgElement.style.fontSize = '10px'
      
      if (sender !== username) {
        msgListTag.className = 'sent';
      } else {
      msgListTag.className = 'replies';
        
      }
      
      
      msgListTag.appendChild(imgTag);
      if (data['content']) {
        var pTag = document.createElement('p'); 
        pTag.textContent = data.content;
        pTag.style.padding = '15px 30px'
        pTag.style.wordWrap = 'break-word'
        pTag.id = 'original_' + `${data['pk']}`
        var dropdownWrapper = document.createElement('div');
        dropdownWrapper.className = 'dropdown';

        // svgElement.setAttribute('class', 'btn btn-secondary dropdown-toggle');
        svgElement.setAttribute('type', 'button');
        svgElement.setAttribute('id', 'dropdownMenuButton');
        svgElement.setAttribute('data-toggle', 'dropdown');
        svgElement.setAttribute('aria-haspopup', 'true');
        svgElement.setAttribute('aria-expanded', 'false');


        // Create the dropdown menu
        var dropdownMenu = document.createElement('div');
        dropdownMenu.className = 'dropdown-menu text-center';
        dropdownMenu.style.minWidth = '40px'
        dropdownMenu.setAttribute('aria-labelledby', 'dropdownMenuButton');

        var dropdownItem = document.createElement('i');
        dropdownItem.className = 'dropdown-item fa fa-reply text-center';
        dropdownItem.href = '#';

        dropdownMenu.appendChild(dropdownItem);

        dropdownMenu.addEventListener('click', function() { 
          if (data['content'].length > 15) {
            tagMessageAndFocus(data['content'].slice(0, 14) + '....')
          }

          else if (data['content'].length <= 15) {
            tagMessageAndFocus(data['content'])
          }
          parentMessageContent = data
        })

        dropdownWrapper.appendChild(svgElement);
        dropdownWrapper.appendChild(dropdownMenu);
        
        msgListTag.appendChild(pTag);
        pTag.appendChild(dropdownWrapper);

        
      }
      if (data['file_content'] !== null) {
        var pTag = document.createElement('button');
        var hrefLink = document.createElement('a')
        hrefLink.href = data['file_content'];
        hrefLink.textContent = 'View File'
        hrefLink.style.textDecoration = 'none'
        pTag.appendChild(hrefLink)
        pTag.style.padding = '10px 30px'
        pTag.style.backgroundColor = 'white'
        pTag.style.float = 'right'
        pTag.style.borderRadius = '10px'
        pTag.style.border = '0px';
        pTag.style.marginBottom = '10px';
        pTag.style.fontSize = '20px'
        pTag.id = 'original_' + `${data['pk']}`

        var dropdownWrapper = document.createElement('div');
        dropdownWrapper.className = 'dropdown';

        svgElement.setAttribute('type', 'button');
        svgElement.setAttribute('id', 'dropdownMenuButton');
        svgElement.setAttribute('data-toggle', 'dropdown');
        svgElement.setAttribute('aria-haspopup', 'true');
        svgElement.setAttribute('aria-expanded', 'false');

        var dropdownMenu = document.createElement('div');
        dropdownMenu.className = 'dropdown-menu text-center';
        dropdownMenu.style.minWidth = '40px'
        dropdownMenu.setAttribute('aria-labelledby', 'dropdownMenuButton');

        var dropdownItem = document.createElement('i');
        dropdownItem.className = 'dropdown-item fa fa-reply text-center';
        dropdownItem.href = '#';

        dropdownMenu.appendChild(dropdownItem);
        dropdownMenu.addEventListener('click', function() { 
          tagMessageAndFocus('File 📁')
          parentMessageContent = data;
        })

        dropdownWrapper.appendChild(svgElement);
        dropdownWrapper.appendChild(dropdownMenu);

        msgListTag.appendChild(pTag);
        pTag.appendChild(dropdownWrapper);
        }
        if ( data['recipient'] === friendUsername) {
        chatLog.appendChild(msgListTag); 
        }

          chatLog.appendChild(time)

        msgListTag.style.padding = '10px';

      }

      function receivedTaggedMessages(data) {
      var sender = data['sender'];
      
      var msgListTag = document.createElement('li');
      msgListTag.style.position = 'relative'
      msgListTag.style.backgroundColor = '#DCDCDC'
      msgListTag.style.borderRadius = '10px'
      var imgTag = document.createElement('img');
      
      if (data['tagged_content']) {
        var tagBox = document.createElement('div');
        tagBox.style.cursor = 'pointer'
        tagBox.id = 'trigger_' + `${data['tagged_pk']}`
        tagBox.textContent = data['tagged_content']
        tagBox.style.padding = '10px 30px'
        tagBox.style.float = 'right'
        tagBox.style.border = 'none';
        tagBox.style.marginBottom = '10px';
        tagBox.style.fontSize = '20px'
        msgListTag.appendChild(tagBox)

        tagBox.addEventListener('click', function() {
        // Call a function to scroll to the tagged message
        gotoTaggedMessage(tagBox.id);
          });
      }

      else if (data['tagged_file_content'] !== null) {
        var tagBox = document.createElement('a');
        tagBox.style.cursor = 'pointer'
        tagBox.id ='trigger_' + `${data['tagged_pk']}`
        tagBox.className = 'tag-box';
        // tagBox.href = data['tagged_file_content']
        tagBox.textContent = 'File 📁'
        tagBox.style.padding = '10px 30px'
        tagBox.style.float = 'right'
        tagBox.style.border = 'none';
        tagBox.style.marginBottom = '10px';
        tagBox.style.fontSize = '20px'
        msgListTag.appendChild(tagBox)

        tagBox.addEventListener('click', function() {
        // Call a function to scroll to the tagged message
        gotoTaggedMessage(tagBox.id);
          });
      }


      var time2 = document.createElement('p');
      time2.style.zIndex = '10000000'
      time2.className = 'time';
      time2.style.padding = '0px 10px'
      time2.textContent = new Date(data['timestamp']).toLocaleString()
      time2.style.float = 'left';
      time2.style.fontStyle = 'italic';
      // time2.style.marginTop = '-25px';
      time2.style.marginLeft = '20px';
      time2.style.fontSize = '15px';
      time2.style.color = 'green'

      imgTag.src = data['sender_pfp_url'];
      imgTag.style.width = "30px";
      imgTag.style.height = "30px";
      imgTag.style.borderRadius = "50%";

      msgListTag.className = 'sent';

      var svgElement = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      svgElement.setAttribute("xmlns", "http://www.w3.org/2000/svg");
      svgElement.setAttribute("height", "50");
      svgElement.setAttribute("width", "12");
      svgElement.style.float = 'left';
      svgElement.setAttribute('transform','translate(-22,65)');
      svgElement.setAttribute("viewBox", "0 0 448 512");

      var pathElement = document.createElementNS("http://www.w3.org/2000/svg", "path");
      pathElement.setAttribute("d", "M201.4 342.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 274.7 86.6 137.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z");
      pathElement.setAttribute('fill', '#F5F5F5');

      svgElement.appendChild(pathElement);
      svgElement.style.marginTop = '-100px';
      svgElement.style.fontSize = '10px'


      msgListTag.appendChild(imgTag);
      if (data['content']) {
        var pTag = document.createElement('p'); 
        pTag.textContent = data.content;
        pTag.style.padding = '15px 30px'
        pTag.style.wordWrap = 'break-word'
        pTag.id = 'original_' + `${data['pk']}`
        // Create a Bootstrap dropdown wrapper
        var dropdownWrapper = document.createElement('div');
        dropdownWrapper.className = 'dropdown';

        // svgElement.setAttribute('class', 'btn btn-secondary dropdown-toggle');
        svgElement.setAttribute('type', 'button');
        svgElement.setAttribute('id', 'dropdownMenuButton');
        svgElement.setAttribute('data-toggle', 'dropdown');
        svgElement.setAttribute('aria-haspopup', 'true');
        svgElement.setAttribute('aria-expanded', 'false');


        // Create the dropdown menu
        var dropdownMenu = document.createElement('div');
        dropdownMenu.className = 'dropdown-menu text-center';
        dropdownMenu.style.minWidth = '40px'
        // dropdownMenu.style.padding = '0px'
        // dropdownMenu.style.margin = '0px'
        dropdownMenu.setAttribute('aria-labelledby', 'dropdownMenuButton');

        dropdownMenu.addEventListener('click', function() { 
          if (data['content'].length > 15) {
            tagMessageAndFocus(data['content'].slice(0, 14) + '....')
          }

          else if (data['content'].length <= 15) {
            tagMessageAndFocus(data['content'])
          }
          parentMessageContent = data
        })

        // Create dropdown item (you can customize this as needed)
        var dropdownItem = document.createElement('i');
        dropdownItem.className = 'dropdown-item fa fa-reply text-center';
        dropdownItem.href = '#';
        // dropdownItem.textContent = 'Tag';
        // dropdownItem.style.width = '40px';

        // Append dropdown item to the dropdown menu
        dropdownMenu.appendChild(dropdownItem);

        // Append dropdown toggle and menu to the dropdown wrapper
        dropdownWrapper.appendChild(svgElement);
        dropdownWrapper.appendChild(dropdownMenu);

        // Append the Bootstrap dropdown wrapper to the message
        // msgListTag.appendChild(dropdownWrapper);

        msgListTag.appendChild(pTag);
        pTag.appendChild(dropdownWrapper);
      }
      if (data['file_content'] !== null) {
        var pTag = document.createElement('button');
        var hrefLink = document.createElement('a')
        hrefLink.href = data['file_content'];
        hrefLink.textContent = 'View File'
        hrefLink.style.textDecoration = 'none'
        hrefLink.style.color = 'white'
        pTag.appendChild(hrefLink)
        pTag.style.backgroundColor = '#435F7A'
        pTag.style.padding = '10px 30px'
        pTag.style.borderRadius = '10px'
        pTag.style.border = '0px';
        pTag.style.marginBottom = '10px';
        pTag.style.fontSize = '20px'
        pTag.id = 'original_' + `${data['pk']}`
        // pTag.appendChild(svgElement);
        // svgElement.setAttribute('transform','translate(-22,88)');
        // msgListTag.appendChild(pTag);
        var dropdownWrapper = document.createElement('div');
        dropdownWrapper.className = 'dropdown';

        // svgElement.setAttribute('class', 'btn btn-secondary dropdown-toggle');
        svgElement.setAttribute('type', 'button');
        svgElement.setAttribute('id', 'dropdownMenuButton');
        svgElement.setAttribute('data-toggle', 'dropdown');
        svgElement.setAttribute('aria-haspopup', 'true');
        svgElement.setAttribute('aria-expanded', 'false');


        // Create the dropdown menu
        var dropdownMenu = document.createElement('div');
        dropdownMenu.className = 'dropdown-menu text-center';
        dropdownMenu.style.minWidth = '40px'
        // dropdownMenu.style.padding = '0px'
        // dropdownMenu.style.margin = '0px'
        dropdownMenu.setAttribute('aria-labelledby', 'dropdownMenuButton');

        dropdownMenu.addEventListener('click', function() { 
          tagMessageAndFocus('File 📁')
          parentMessageContent = data
        })

        // Create dropdown item (you can customize this as needed)
        var dropdownItem = document.createElement('i');
        dropdownItem.className = 'dropdown-item fa fa-reply text-center';
        dropdownItem.href = '#';
        // dropdownItem.textContent = 'Tag';
        // dropdownItem.style.width = '40px';

        // Append dropdown item to the dropdown menu
        dropdownMenu.appendChild(dropdownItem);

        // Append dropdown toggle and menu to the dropdown wrapper
        dropdownWrapper.appendChild(svgElement);
        dropdownWrapper.appendChild(dropdownMenu);

        // Append the Bootstrap dropdown wrapper to the message
        // msgListTag.appendChild(dropdownWrapper);

        msgListTag.appendChild(pTag);
        pTag.appendChild(dropdownWrapper);
      }
      
      chatLog.appendChild(msgListTag); 
      chatLog.appendChild(time2)
      msgListTag.style.padding = '10px';
    }

    function tagMessageAndFocus(message) {
      
            if (insertedTaggedMessage) {
                insertedTaggedMessage.parentNode.removeChild(insertedTaggedMessage);
              }

            // Create a new div for the tagged message
            var taggedMessageDiv = document.createElement('div');
            taggedMessageDiv.textContent = 'Tagged message: ' + message;
            taggedMessageDiv.style.backgroundColor = '#eee';
            taggedMessageDiv.style.padding = '10px';
            // taggedMessageDiv.style.marginBottom = '10px';
            taggedMessageDiv.style.fontSize = '20px'
            // var messageType = document.getElementById('message_type')
            messageType.value = 'tagged';

            // Create a close button
            var closeButton = document.createElement('button');
            closeButton.textContent = 'x';
            closeButton.style.backgroundColor = '#EEEEEE';
            closeButton.style.color = '#435F7A'
            closeButton.style.marginTop = '-10px'
            closeButton.className = 'close-button';
            closeButton.addEventListener('click', function() {
                // Remove the tagged message when the close button is clicked
                taggedMessageDiv.parentNode.removeChild(taggedMessageDiv);
                insertedTaggedMessage = null; // Reset the reference
                messageType.value = 'normal';
            });

            // Append the close button to the tagged message
            taggedMessageDiv.appendChild(closeButton);

            // Get the reference to the message input field
            var messageInput = document.getElementById('chat-message-input1');

            // Insert the tagged message above the input field
            messageInput.parentNode.insertBefore(taggedMessageDiv, messageInput);
            
            insertedTaggedMessage = taggedMessageDiv;

            // Focus on the message input field to bring up the keyboard
            messageInput.focus();

        }
    function tagMessage(parentMessage) {
      var messageInputDom = document.querySelector('#chat-message-input1');
      var message = messageInputDom.value;
      friendsChatSocket.send(
      JSON.stringify(
        {
          'command': 'tag_message',
          'sender': username,
          'recipient': friendUsername,
          'parentMessage': parentMessage,
          'message': message
        }
      )
    )
    }
    
    function gotoTaggedMessage(taggedMsgPk) {
      var messageId = 'original_' + taggedMsgPk.slice(8, taggedMsgPk.length)
      // Find the actual message element by its identifier or data attribute
      var messageElement = document.getElementById(messageId);
      messageElement = messageElement.parentElement
      messageElement.style.backgroundColor = '#50C878'; // Set your preferred background color
      messageElement.style.padding = '10px';
      messageElement.style.borderRadius = '10px';
      messageElement.style.boxShadow = '0 8px 10px rgba(0, 0, 0, 0.1)';
      // messageElement.style.height = '70px'

      // Set a timeout to remove the styles after 5 seconds
      setTimeout(function () {
          messageElement.style.backgroundColor = ''; // Reset the background color
          messageElement.style.padding = '10px';
          messageElement.style.borderRadius = '';
          messageElement.style.boxShadow = '';
          messageElement.style.height = '';
      }, 5000); // Adjust the time (in milliseconds) as needed
      if (messageElement) {
          // Scroll to the position of the message element
          messageElement.scrollIntoView({
              behavior: 'smooth',
              block: 'start',
          });
      }
    }
  
  };
  $('.friend-conversation').click(handleFriendClick);
</script>
<!-- <script>
  document.addEventListener("DOMContentLoaded", function() {
      var element = document.getElementById('scrollToBottomIcon');
      element.addEventListener('click', function () {
          console.log('called');
          window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
      });
  });
</script> -->




<script>
  var insertedTaggedMessage2
    document.getElementsByClassName('group-chat-tab')[0].addEventListener('click', function () {
      document.getElementById('content-1').style.display = 'none';
    })
    var username = "{{ username }}"

    oldGroups = []
    oldGroupSockets = []
    oldGroupPk = []

    function handleGroupClick() {

      var fileMsg = document.querySelector('#file-msg2')
      var fileIcon = document.querySelector('#clip-2')
      var messageType = document.getElementById('message_type2')
      messageType.value = 'normal';

      function removeTaggedMessage2() {
      var parentMessageContent;
      document.getElementById('chat-message-input2').value = '';
      if (insertedTaggedMessage2) {
        insertedTaggedMessage2.parentNode.removeChild(insertedTaggedMessage2); 
        insertedTaggedMessage2 = null; // Reset the reference
        messageType.value = 'normal';
      }
    }

    removeTaggedMessage2()

    if (oldGroupSockets.length > 0) {
      var previousSocket = oldGroupSockets[oldGroupSockets.length-1];
      previousSocket.close()
    }

      groupMembersObject = {}

      var addedTimestamps = []
      var content2 = document.getElementById('content-2')
      content2.style.display = 'block';
      var floatingClass = content2.querySelector('.floating')
      var chatLog = content2.querySelector('#chat-log-2')
      
      chatLog.innerHTML = ''
      floatingClass.innerHTML = ''

      var groupPk = $(this).data('group-pk')
      var groupName = $(this).data('group-name');
      var groupDesc = $(this).data('group-desc');
      
      oldGroupPk.push(groupPk)

      getGroupMembersUrl = "{% url 'chat:get_group_members' group_pk=0 %}".replace('0', groupPk)
      $.ajax({
        url: getGroupMembersUrl,
        type: 'GET',
        dataType: 'json',
        success: function(data) {
          groupMembersObject['members'] = data.members
          console.log('GM: ', groupMembersObject);
        }
      })

      var membersCount = $(this).data('members-count')
      var groupNameSlot = content2.querySelector('#group_name')
      var groupPfpSlot = content2.querySelector('#group_pfp')
      var contactProfile = content2.querySelector('#contact-profile-1')
      var contactProfile2 = content2.querySelector('#contact-profile-2')
      var createGroupDesc = document.createElement('p');
      var groupCountSlot = content2.querySelector('#members-count-slot')
      
      groupCountSlot.innerHTML = `Members: <span style="font-weight: bold;">${membersCount}</span>`;
      groupCountSlot.style.position = 'absolute';
      groupCountSlot.style.left = '80px';
      groupCountSlot.style.float = 'left'
      groupCountSlot.style.top = '35px'
      contactProfile.style.backgroundColor = '#2C3E50'
      contactProfile2.style.backgroundColor = '#2C3E50'
      contactProfile.style.color = 'white'
      contactProfile2.style.color = 'white'
      contactProfile2.appendChild(groupCountSlot)
      // createMembersCount.style.position = 'absolute';
      // createMembersCount.style.right = '7px'
      oldGroups.push(groupName)

      groupNameSlot.textContent = groupName;
      // contactProfile.appendChild(createMembersCount)
      groupPfpSlot.style.marginTop = '20px'
      groupPfpSlot.src = "{% static 'images/group.jpg' %}"
      // document.getElementById('description').textContent = groupDesc
      createGroupDesc.textContent = groupDesc
      createGroupDesc.style.padding = '20px'
      createGroupDesc.style.position = 'absolute'
      createGroupDesc.style.color = 'white'
      createGroupDesc.style.top = '90px'
      createGroupDesc.style.borderTop = '1px solid white';
      // #d1ecf1
      createGroupDesc.style.backgroundColor = '#2C3E50'
      
      content2.querySelector('.messages').appendChild(createGroupDesc)
      content2.querySelector('.message-input').style.display = 'inline';

      var groupChatSocket = new ReconnectingWebSocket(
        'ws://' + window.location.host + '/ws/chat/groups/'
      );
      

      groupChatSocket.onopen = function(e) {
        fetchGroupMessages(groupPk);
      }

      function checkIfUserIsInGroup(userUsername) {
        return groupMembersObject.some(participant => participant.username === userUsername);
      }

      groupChatSocket.onmessage = function(e) {
        var data = JSON.parse(e.data);

        if (data['command'] === 'group_messages') {
          var isUserInGroup = checkIfUserIsInGroup(username);
          for (let i = 0; i < data['messages'].length; i++) {
            if (typeof data['messages'][i].tagged_pk === 'undefined') {

              if (data['messages'][i].sender === username) {
                senderMessages(data['messages'][i])
              }
               else if (data['messages'][i].sender !== username && isUserInGroup) {
                receivedMessage(data['messages'][i])
               }

            }

            if (typeof data['messages'][i].tagged_pk !== 'undefined') {
              if (data['messages'][i].sender === username) {
                  senderTaggedMessages(data['messages'][i])
              }
              else if (data['messages'][i].sender !== username && isUserInGroup) {
                receivedTaggedMessages(data['messages'][i])
              }
            }
          }
        }

        else if (data['command'] === 'new_group_message') {
          if (data['message'].sender === username) {
            content2.querySelector('.floating').innerHTML = ''; 

            if (data['message'].sender === username ) {
              senderMessages(data['message']);
            }

            else if (data['message'].sender !== username && isUserInGroup && data['message'].group_name === oldGroups[oldGroups.length -1]) {
              receivedMessage(data['message'])
            }

            if (isUserInGroup && data['message'].sender !== username && data['message'].group_name === oldGroups[oldGroups.length -1]) { 
              createNewMessageNotif(username, data['message'].pk)
            }
          }
        }

        else if (data['command'] === 'tagged_new_group_message' || data['command'] === 'new_file_tagged') {
          if (data['message'].sender === username) {
          content2.querySelector('.floating').innerHTML = ''; 
        }

        if (data['message'].sender === username ) {
          senderTaggedMessages(data['message']);
        }

        else if (isUserInGroup && data['message'].sender !== username && data['message'].group_name === oldGroups[oldGroups.length -1]) {
          receivedTaggedMessages(data['message'])
        }

        if (isUserInGroup && data['message'].group_name === oldGroups[oldGroups.length -1] && data['message'].sender !== username) {
          createNewMessageNotif(username, data['message'].pk)
        }
        }

        else if (data['command'] === 'new_file_normal') {
          if (data['message'].sender === username) {
            content2.querySelector('.floating').innerHTML = ''; 
          }
          if (data['message'].sender === username) {
            senderMessages(data['message']);
          }

          else if (data['message'].sender !== username && isUserInGroup && data['message'].group_name === oldGroups[oldGroups.length -1]) {
            receivedMessage(data['message'])
          }

          if (isUserInGroup && data['message'].group_name === oldGroups[oldGroups.length -1] && data['message'].sender !== username) {
            createNewMessageNotif(username, data['message'].pk)
          }
        }
      }

      // END OF GROUPCHATSOCKET.ONMESSAGE

      function sendMessage() {
      if (messageType.value === 'normal') {
        var messageInputDom = document.querySelector('#chat-message-input2');
        var message = messageInputDom.value;
        groupChatSocket.send(JSON.stringify({
        'command': 'send_new_group_message',
        'message': message,
        'type': 'normal',
        'from': username,
        'groupPk': groupPk
      }));
      messageInputDom.value = '';
      }

      else if (messageType.value === 'tagged') {
        var messageInputDom = document.querySelector('#chat-message-input2');
        var message = messageInputDom.value;
        groupChatSocket.send(JSON.stringify({
          'command': 'tag_group_message',
          'from': username,
          'type': 'tagged',
          'groupPk': groupPk,
          'parentMessagePk': parentMessageContent['pk'],
          'message': message
        }));
        messageInputDom.value = '';
        removeTaggedMessage()
      }

      else {
        console.log('This instance is not pre-defined.');
      }
      
    }

    groupChatSocket.onclose = function(e) {
      console.error('Chat socket closed unexpectedly');
    };

    document.querySelector('#chat-message-input2').onkeyup = function(e) {
      if (e.keyCode === 13) {  
        document.querySelector('#chat-message-submit2').click();
      }
    };

    document.querySelector('#chat-message-submit2').onclick = function(e) {
      sendMessage()
    };

    fileIcon.onclick = function(e) {
      fileMsg.click();
    }

    fileMsg.onchange = function(e) {
      e.preventDefault()

      
      var fileMessageType;
      if (messageType.value === 'normal') {
        var sendFileUrl = "{% url 'chat:send_group_file_msg' sender=0 group_pk=1 %}".replace('0', username).replace('1', groupPk); 
        fileMessageType = 'normal';
      }
      else if (messageType.value === 'tagged') {
        var sendFileUrl = "{% url 'chat:send_group_file_msg_with_parent' sender=0 group_pk=1 parent_message=2 %}".replace('0', username).replace('1', groupPk).replace('2', parentMessageContent.pk); 
        fileMessageType = 'tagged';
      }
      var file = fileMsg.files[0];
      var formData = new FormData();
      formData.append('file', file)
      $.ajax({
        processData: false,
        contentType: false,
        async: false,
        type: 'POST',
        cache: false,
        url: sendFileUrl,
        data: formData,
        headers: {
          'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(response) {
          groupChatSocket.send(JSON.stringify({
            'command': `new_file_${fileMessageType}`,
            'message': response,
            'sender': username,
            'message_type': fileMessageType,
            'groupPk': groupPk
          }));
          // fileMsg.value = '';
           if (username === response.message_recipient) {
            receivedFileMessage(response)
          } 
          removeTaggedMessage2()
        }
        
      })
    }
    }
    $('.group-conversation').click(handleGroupClick)
</script>

</body>

</html>