{% extends 'base.html' %}
{% load static %}
{% block title %}Fund or Withdraw{% endblock title %}
{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
<div class="container">

    <div>
        <div id="tab-deposit" class="mb-5" style="background-color: whitesmoke;padding: 40px;">
            <div class="row">
                <div class="col-12 col-lg-12">
                    <script src="https://js.paystack.co/v1/inline.js"></script>
                    <form class="mb-4" method="POST" id="payForm" action="{% url 'deposit' %}">
                        {% csrf_token %}
                        <h4>Deposit</h4>
                        <input type="text" id="hide" style="visibility: hidden;" value="False" name="bool">
                        <p>To begin investing you need to deposit funds to your Investor Account by making transfer to the bank account stated below. Processing may take up to 2-3 working days. Once deposited funds are added to your Investor Account, you will receive a confirmation e-mail and will be able to make investments.</p>
                        <input type="number" step="0.1" min=0 placeholder="Amount" name="amount" id="amount">
                        <button onclick="makePayment()" name="deposit" type="button" class="button button-primary">DEPOSIT</button>
                    </form>
                </div>
            </div>
        </div>
        <div id="tab-withdraw" style="background-color: whitesmoke; padding: 40px;margin-bottom: 50px;">
            <div class="row">
                <div class="col-12 col-lg-12">
                    <!-- Modal -->
                    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Beneficiary Account Details</h5>
                            <!-- <button type="button" class="btn-close close" data-bs-dismiss="modal" aria-label="Close"></button> -->
                            </div>
                            <div class="modal-body px-2" id="modal_body">
                                <div>
                                    <span class="fw-bold">Bank Name: </span>
                                    <span id="bank_name"></span>
                                </div>
                                <div class="mt-2">
                                    <span class="fw-bold">Account Number: </span>
                                    <span id="account_number"></span>
                                </div>
                                <div class="mt-2">
                                    <span class="fw-bold">Account Name: </span>
                                    <span id="account_name"></span>
                                </div>
                                <div class="mt-2">
                                    <span class="fw-bold">Amount: </span>
                                    ₦<span id="withdraw_amount"></span>
                                </div>
                        </div>
                        <div id="modal_body2">

                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary close" data-bs-dismiss="modal" id="close">Close</button>
                            <a href="{% url 'deposit' %}">
                                <button type="button" class="btn btn-success" id="confirmWithdrawal">Confirm Withdrawal</button>
                            </a>
                          </div>
                        </div>
                      </div>
                    </div>
                    <form name="withdraw_form" method="POST" action="{% url 'deposit' %}" id="withdraw_form">
                        {% csrf_token %}
                        <h4>Withdraw</h4>
                        <div class="mb-3">
                            <span class="fw-bold">Available Funds: </span>
                            ₦{{ innovator.account_balance }}
                        </div>
                        <div class="data-box">
                            
                            <input name="withdraw_amount" type="number" step="0.1" min=0 placeholder="Amount" value="{{ withdraw_amount }}">
                            
                            
                            <input name="withdraw_to" type="text" placeholder="Account Number" value="{{ account_number }}">
                            
                            {% if status %}
                            <input type="text" name="withdraw_2" id="" hidden>
                            {% endif %}
                            
                            <!-- <div class="data-actions"><button type="submit" name="withdraw_2">Withdraw</button></div> -->
                            <select id="bank_code" name="bank_code">
                                <option value="{{ bank_code }}" selected>{{ bank_name }}</option>
                                {% for bank in banks %}
                                <option value='{{ bank.code }}'>{{ bank.name }}</option>
                                {% endfor %}
                            </select>

                            <div class="data-actions">
                                <button type="button" name="withdraw" id="initialWithdrawButton" data-bs-toggle="modal" data-bs-target="#exampleModal">Withdraw</button>
                            </div>
                            <!-- <button class="mt-3 button button-primary" type="submit">
                                Withdraw
                            </button> -->
                        </div>
                    </form>
                    
                </div>
            </div>
        </div>
        
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // document.getElementById('make-payment-btn').addEventListener('click', makePayment);
    function makePayment(){
        let amount = document.getElementById('amount').value
    // e.preventDefault();
    let handler = PaystackPop.setup({
            key: 'pk_test_94c9c0292b58b03a1e0feaa5b1b1da81b04b0873', //public key from your paystack
            email: '{{ user.email }}',
            amount:`${amount}` * 100,
            currency:'NGN',
            // ref: ''+Math.floor((Math.random() * 100000000) + 1),
            // ref: ''+Math.floor((Math.random() * 1000000000) + 1),
            callback: function(response){
        document.getElementById('hide').value = 'True';
        
        // document.getElementById('hide').style.visibility = 'visible';
        document.getElementById('payForm').submit();
        alert('Success. Transaction ref is ' +response.reference);
    },
    onClose: function(){
        alert('Window Closed');
    }
    });
    handler.openIframe();
}
// window.onload = makePayment()
</script>

<!-- <script>
    $(document).ready(function() {
      // Listen for the form submission
      $('form[name="withdraw_form"]').submit(function(e) {
        e.preventDefault(); // Prevent the form from submitting the traditional way
  
        // Use AJAX to submit the form data and check for correctness on the server
        $.ajax({
          type: 'POST',
          url: '{% url "deposit" %}',
          data: $(this).serialize(), // Serialize form data
          success: function(response) {
            if (response.is_valid) {
              // Display the modal if the form is valid
            //   window.location.href = '{% url "deposit" %}';
              console.log('YESSIRRRR')
              $('#myModal').modal('show');
            } else {
              // Handle form errors here if needed
              console.log('Form is not valid');
            }
          },
        });
      });
  
      // Trigger the modal when the button is clicked
      $('#myModalBtn').click(function() {
        $('#myModal').modal('show');
      });
    });
  </script> -->
  <!-- <script>
    // window.onload = function () {
    //     OpenBootstrapPopup();
    // };
    const withdraw1Button = document.getElementById("withdraw_1");
    const withdrawForm = document.getElementById("withdraw_form");
    withdraw1Button.addEventListener("click", function() {
      // Submit the form when the button is clicked
      withdrawForm.submit();
      $("#Modal").modal('show');
    });
  </script> -->
  <script>
    window.onload = function () {
        OpenBootstrapPopup();
    };
    function OpenBootstrapPopup() {
        $("#Modal").modal('show');
    }
</script>

<script>
    $(document).ready(function () {
        $("#initialWithdrawButton").click(function () {
            console.log("Button clicked!");
            var formData = $("#withdraw_form").serialize();
            console.log(formData)
            // Manually add the CSRF token to the data
            formData += '&csrfmiddlewaretoken=' + $("[name=csrfmiddlewaretoken]").val();
            $.ajax({
                type: "POST",
                url: "{% url 'get_bank_details' %}",
                data: formData,
                success: function (response) {
                    if (response.status === 'success') {
                    // Update the resultDiv with the response data
                    console.log('RESPONSE: ', response)
                    $("#bank_name").html(response.bank_name);
                    $("#account_number").html(response.account_data.account_number);
                    $("#account_name").html(response.account_data.account_name);
                    $("#withdraw_amount").html(response.withdraw_amount);
                    $('#modal_body').show();
                    $('#modal_body2').hide()
                    $('#confirmWithdrawal').show();
                    }
                    else {
                        $('#confirmWithdrawal').hide();
                        $('#modal_body').hide();
                        $("#modal_body2").html('Could not resolve account name');
                        
                    }
                },
                // error: function (xhr, status, error) {
                //     console.log('yessirrr')
                //     $('#confirmWithdrawal').hide();
                //     $("#modal_body").html('Could not resolve account name');

                // }
            });
            
        });
    });
</script>
  
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
{% endblock content %}